name: Update Pixi lockfile

on:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: prefix-dev/setup-pixi@v0.9.2
        with:
          pixi-version: v0.50.2
          cache: false

      - name: Run Pixi update
        run: pixi update

      - name: Determine trigger message
        id: trigger
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            rel_url="${{ github.event.release.html_url }}"
            rel_tag="${{ github.event.release.tag_name }}"
            echo "msg=Triggered by [release ${rel_tag}](${rel_url})." >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "msg=Triggered by a scheduled run." >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "msg=Triggered manually by ${{ github.actor }}." >> $GITHUB_OUTPUT
          else
            echo "msg=Triggered automatically by ${{ github.event_name }}." >> $GITHUB_OUTPUT
          fi

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update pixi dependencies"
          title: "Update pixi lockfile"
          body: |
            This PR was automatically generated by the **Pixi lockfile update workflow**.

            ${{ steps.trigger.outputs.msg }}

            **Workflow details:**
            - Actor: `${{ github.actor }}`
            - Branch: `${{ github.ref_name }}`
            - Workflow run: [View run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          branch: "auto/pixi-update"
          base: "main"
          delete-branch: true
          labels: dependencies, github_actions, chore
